<ion-header [translucent]="true" class="profile-header">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="triggerCelebration()">
        <ion-icon slot="icon-only" name="sparkles" class="celebrate-icon"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="header-title">Disaster Response Profile</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="toggleEditMode()">
        <ion-icon [name]="isEditMode ? 'checkmark-circle' : 'pencil'" class="edit-mode-icon"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="profile-content" (ionScroll)="handleScroll($event)">
  <!-- Profile Hero Section -->
  <div class="profile-hero" [class.scrolled]="contentScrolled">
    <div class="profile-background"></div>
    <div class="profile-content-wrapper">
      <div class="avatar-container" (click)="changeProfilePhoto()" [class.edit-active]="isEditMode">
        <ion-avatar class="user-avatar">
          <img [src]="user.profileImage || 'assets/img/profile.jpg'" alt="User profile" />
          <div class="edit-badge" *ngIf="isEditMode">
            <ion-icon name="camera"></ion-icon>
          </div>
        </ion-avatar>
        <div class="verification-badge" *ngIf="user.isVerified">
          <ion-icon name="checkmark-circle"></ion-icon>
        </div>
      </div>

      <div class="user-info">
        <h2 class="user-name" [contentEditable]="isEditMode">{{ user.name }}</h2>
        <p class="user-role">{{ user.role }}</p>
        <ion-chip outline color="warning" class="response-level">
          <ion-icon name="alert-circle"></ion-icon>
          <ion-label>Response Level: {{ user.responseLevel }}</ion-label>
        </ion-chip>
      </div>
    </div>

    <div class="quick-stats">
      <div class="stat-item" *ngFor="let stat of quickStats" (click)="stat.action()">
        <div class="stat-value">{{ stat.value }}</div>
        <div class="stat-label">{{ stat.label }}</div>
      </div>
    </div>
  </div>

<!-- Enhanced Emergency Information Section -->
<ion-card class="emergency-card" [class.emergency-mode]="isEmergencyMode">
  <div class="emergency-alert-banner" *ngIf="isEmergencyMode">
    <ion-icon name="alert-circle"></ion-icon>
    <span>Emergency Mode Active</span>
    <ion-button fill="clear" size="small" color="light" (click)="toggleEmergencyMode()">
      Disable
    </ion-button>
  </div>

  <ion-card-header class="emergency-header">
    <div class="header-content">
      <div class="title-section">
        <ion-icon name="warning" class="pulse-icon"></ion-icon>
        <ion-card-title>Emergency Readiness</ion-card-title>
        <ion-badge [color]="getReadinessColor()" class="readiness-badge">
          {{ calculateReadinessScore() }}% Ready
        </ion-badge>
      </div>
      <ion-button fill="clear" size="small" (click)="toggleEmergencyMode()" [color]="isEmergencyMode ? 'light' : 'primary'">
        <ion-icon [name]="isEmergencyMode ? 'flash-off' : 'flash'" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
    
    <ion-progress-bar 
      [value]="calculateReadinessScore() / 100" 
      [color]="getReadinessColor()"
      class="readiness-progress">
    </ion-progress-bar>
  </ion-card-header>

  <ion-list lines="none" class="emergency-info-list">
    <!-- Medical Information with Expandable Details -->
    <ion-item class="info-item expandable" (click)="toggleExpand('medical')" [class.expanded]="expandedSections.medical">
      <div class="item-content">
        <div class="item-header">
          <ion-icon 
            name="medkit" 
            [color]="user.medicalInfo.bloodType ? 'success' : 'warning'" 
            class="item-icon pulse-animation">
          </ion-icon>
          <ion-label>
            <h3>Medical Information</h3>
            <p>{{ user.medicalInfo.bloodType ? 'Complete' : 'Needs attention' }}</p>
          </ion-label>
        </div>
        <ion-icon 
          [name]="expandedSections.medical ? 'chevron-up' : 'chevron-down'" 
          class="expand-icon">
        </ion-icon>
      </div>
    </ion-item>

    <div class="expandable-content" [class.expanded]="expandedSections.medical">
      <ion-item>
        <ion-icon name="water" slot="start" color="danger"></ion-icon>
        <ion-label>
          <h4>Blood Type</h4>
          <p>{{ user.medicalInfo.bloodType || 'Not specified' }}</p>
        </ion-label>
        <ion-button fill="clear" size="small" (click)="editBloodType($event)">
          <ion-icon name="create" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-item>

      <ion-item>
        <ion-icon name="alert-circle" slot="start" color="warning"></ion-icon>
        <ion-label>
          <h4>Allergies & Conditions</h4>
          <p>{{ user.medicalInfo.allergies?.join(', ') || 'None reported' }}</p>
        </ion-label>
        <ion-button fill="clear" size="small" (click)="editAllergies($event)">
          <ion-icon name="create" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-item>

      <ion-item>
        <ion-icon name="medical" slot="start" color="tertiary"></ion-icon>
        <ion-label>
          <h4>Medications</h4>
          <p>{{ user.medicalInfo.medications?.join(', ') || 'None listed' }}</p>
        </ion-label>
      </ion-item>
    </div>

    <!-- Emergency Contacts with Quick Action -->
    <ion-item class="info-item" (click)="manageContacts()">
      <div class="item-content">
        <div class="item-header">
          <ion-icon 
            name="people" 
            [color]="emergencyContacts.length > 0 ? 'success' : 'danger'" 
            class="item-icon">
          </ion-icon>
          <ion-label>
            <h3>Emergency Contacts</h3>
            <p>{{ emergencyContacts.length }} contact(s) configured</p>
          </ion-label>
        </div>
        <div class="contact-actions">
          <ion-button fill="clear" size="small" (click)="quickCall($event, emergencyContacts[0])" *ngIf="emergencyContacts.length > 0">
            <ion-icon name="call" color="success"></ion-icon>
          </ion-button>
          <ion-icon name="chevron-forward" class="forward-icon"></ion-icon>
        </div>
      </div>
    </ion-item>

    <!-- Emergency Kit Status -->
    <ion-item class="info-item" (click)="checkEmergencyKit()">
      <div class="item-content">
        <div class="item-header">
          <ion-icon 
            name="briefcase" 
            [color]="emergencyKitStatus.complete ? 'success' : 'warning'" 
            class="item-icon">
          </ion-icon>
          <ion-label>
            <h3>Emergency Kit</h3>
            <p>{{ emergencyKitStatus.complete ? 'Complete' : 'Needs review' }}</p>
          </ion-label>
        </div>
        <ion-badge [color]="emergencyKitStatus.complete ? 'success' : 'warning'">
          {{ emergencyKitStatus.itemsChecked }}/{{ emergencyKitStatus.totalItems }}
        </ion-badge>
      </div>
    </ion-item>

    <!-- Emergency Plan -->
    <ion-item class="info-item" (click)="viewEmergencyPlan()">
      <div class="item-content">
        <div class="item-header">
          <ion-icon name="document-text" color="primary" class="item-icon"></ion-icon>
          <ion-label>
            <h3>Emergency Plan</h3>
            <p>Family meeting points & procedures</p>
          </ion-label>
        </div>
        <ion-icon name="document" color="medium"></ion-icon>
      </div>
    </ion-item>

    <!-- SOS Quick Action -->
    <ion-item class="sos-item" *ngIf="isEmergencyMode">
      <ion-button 
        expand="block" 
        color="danger" 
        fill="solid" 
        (click)="triggerSOS()"
        class="sos-button pulse-alert">
        <ion-icon name="alert-circle" slot="start"></ion-icon>
        EMERGENCY SOS
        <div class="sos-countdown" *ngIf="sosCountdown > 0">{{ sosCountdown }}</div>
      </ion-button>
    </ion-item>
  </ion-list>

  <!-- Quick Actions Footer -->
  <ion-card-content class="quick-actions" *ngIf="!isEmergencyMode">
    <ion-button fill="clear" size="small" (click)="shareEmergencyInfo()">
      <ion-icon name="share-social" slot="start"></ion-icon>
      Share Info
    </ion-button>
    <ion-button fill="clear" size="small" (click)="printEmergencyCard()">
      <ion-icon name="print" slot="start"></ion-icon>
      Print Card
    </ion-button>
    <ion-button fill="clear" size="small" (click)="testEmergencyAlert()">
      <ion-icon name="notifications" slot="start"></ion-icon>
      Test Alert
    </ion-button>
  </ion-card-content>
</ion-card>

<!-- Disaster Preparedness Section -->
  <ion-card class="preparedness-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="shield-checkmark" class="section-icon"></ion-icon>
        My Preparedness
      </ion-card-title>
      <ion-badge color="success" mode="ios">{{ preparednessScore }}/100</ion-badge>
    </ion-card-header>

    <ion-list lines="none">
      <ion-item *ngFor="let item of preparednessItems">
        <ion-icon [name]="item.icon" slot="start" [color]="item.completed ? 'success' : 'medium'"></ion-icon>
        <ion-label>
          <h3>{{ item.name }}</h3>
          <p>{{ item.description }}</p>
        </ion-label>
        <ion-toggle slot="end" [(ngModel)]="item.completed" (ionChange)="updatePreparedness()"></ion-toggle>
      </ion-item>
    </ion-list>
  </ion-card>

  <!-- App Settings Section -->
  <ion-card class="settings-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="settings" class="section-icon"></ion-icon>
        App Configuration
      </ion-card-title>
    </ion-card-header>

    <ion-list lines="none">
      <ion-item button (click)="toggleDarkMode()">
        <ion-icon name="moon" slot="start" color="tertiary"></ion-icon>
        <ion-label>Dark Mode</ion-label>
        <ion-toggle slot="end" [(ngModel)]="settings.darkMode"></ion-toggle>
      </ion-item>
      <ion-item button (click)="toggleEmergencyAlerts()">
        <ion-icon name="notifications" slot="start" color="warning"></ion-icon>
        <ion-label>Emergency Alerts</ion-label>
        <ion-toggle slot="end" [(ngModel)]="settings.emergencyAlerts"></ion-toggle>
      </ion-item>
      <ion-item button (click)="openLocationSettings()">
        <ion-icon name="location" slot="start" color="primary"></ion-icon>
        <ion-label>Location Sharing</ion-label>
        <ion-toggle slot="end" [(ngModel)]="settings.locationSharing"></ion-toggle>
      </ion-item>
    </ion-list>
  </ion-card>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <ion-button expand="block" fill="outline" color="medium" (click)="openTraining()">
      <ion-icon name="school" slot="start"></ion-icon>
      Training Resources
    </ion-button>
    <ion-button expand="block" color="danger" (click)="confirmLogout()">
      <ion-icon name="log-out" slot="start"></ion-icon>
      Sign Out
    </ion-button>
  </div>

  <!-- Celebration Elements -->
  <div class="confetti-container" *ngIf="showConfetti">
    <div class="confetti" *ngFor="let confetti of confettiPieces" [style.left.px]="confetti.left"
      [style.animation-delay.ms]="confetti.delay" [style.background]="confetti.color"></div>
  </div>
</ion-content>