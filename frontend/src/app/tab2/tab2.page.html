<ion-header [translucent]="true" class="alert-header">
  <ion-toolbar color="primary" class="header-toolbar">
    <ion-buttons slot="start">
      <ion-button (click)="playNotificationSound()" class="notification-btn">
        <ion-icon name="notifications" slot="icon-only"></ion-icon>
        <ion-badge color="danger" *ngIf="unreadAlerts > 0" class="notification-badge">
          {{unreadAlerts > 99 ? '99+' : unreadAlerts}}
        </ion-badge>
      </ion-button>
      <ion-button (click)="toggleSoundSettings()" class="sound-btn">
        <ion-icon [name]="soundEnabled ? 'volume-high' : 'volume-mute'" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    
    <ion-title class="header-title">
      <div class="title-content">
        <span class="live-pulse"></span>
        <span class="title-text">Live Emergency Alerts</span>
        <span class="live-indicator" *ngIf="isConnected">
          <ion-spinner name="lines" *ngIf="isLoading"></ion-spinner>
          <ion-icon name="wifi" *ngIf="!isLoading"></ion-icon>
          Live
        </span>
      </div>
    </ion-title>
    
    <ion-buttons slot="end">
      <ion-button (click)="toggleAlertFilter()" [class.active]="showFilters" class="filter-btn">
        <ion-icon name="filter" slot="icon-only"></ion-icon>
        <ion-badge color="primary" *ngIf="alertFilter !== 'all'" class="filter-badge"></ion-badge>
      </ion-button>
      <ion-button (click)="refreshAlerts()" [class.refreshing]="isRefreshing" class="refresh-btn">
        <ion-icon [name]="isRefreshing ? 'refresh-circle' : 'refresh'" slot="icon-only" [class.spinning]="isRefreshing"></ion-icon>
      </ion-button>
      <ion-button (click)="openSettings()" class="settings-btn">
        <ion-icon name="settings" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Alert Filters -->
  <ion-toolbar *ngIf="showFilters" class="filter-toolbar" @slideDown>
    <div class="filter-content">
      <ion-segment [(ngModel)]="alertFilter" (ionChange)="applyFilters()" class="filter-segment">
        <ion-segment-button value="all">
          <ion-icon name="apps"></ion-icon>
          <ion-label>All</ion-label>
        </ion-segment-button>
        <ion-segment-button value="active">
          <ion-icon name="alert-circle"></ion-icon>
          <ion-label>Active</ion-label>
        </ion-segment-button>
        <ion-segment-button value="natural">
          <ion-icon name="flash"></ion-icon>
          <ion-label>Natural</ion-label>
        </ion-segment-button>
        <ion-segment-button value="medical">
          <ion-icon name="medkit"></ion-icon>
          <ion-label>Medical</ion-label>
        </ion-segment-button>
        <ion-segment-button value="security">
          <ion-icon name="shield-checkmark"></ion-icon>
          <ion-label>Security</ion-label>
        </ion-segment-button>
      </ion-segment>
      
      <ion-button fill="clear" size="small" (click)="clearFilters()" class="clear-filters">
        <ion-icon name="close-circle" slot="start"></ion-icon>
        Clear
      </ion-button>
    </div>
  </ion-toolbar>

  <!-- Search Bar -->
  <ion-toolbar *ngIf="showSearch" class="search-toolbar" @slideDown>
    <ion-searchbar 
      [(ngModel)]="searchQuery" 
      (ionInput)="applyFilters()" 
      placeholder="Search alerts..." 
      animated="true"
      class="alert-searchbar">
    </ion-searchbar>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="alert-content" [scrollEvents]="true" (ionScroll)="onContentScroll($event)">
  <!-- Quick Actions Bar -->
  <div class="quick-actions-bar" [class.hidden]="isScrolled">
    <ion-button fill="clear" size="small" (click)="showSearch = !showSearch" class="action-btn">
      <ion-icon name="search" slot="start"></ion-icon>
      Search
    </ion-button>
    <ion-button fill="clear" size="small" (click)="toggleSortOrder()" class="action-btn">
      <ion-icon [name]="sortOrder === 'newest' ? 'time' : 'trending-up'" slot="start"></ion-icon>
      {{sortOrder === 'newest' ? 'Newest' : 'Priority'}}
    </ion-button>
    <ion-button fill="clear" size="small" (click)="markAllAsRead()" class="action-btn" [disabled]="unreadAlerts === 0">
      <ion-icon name="eye" slot="start"></ion-icon>
      Mark Read
    </ion-button>
    <ion-button fill="clear" size="small" (click)="toggleInteractiveGuide()" class="action-btn">
      <ion-icon name="help-circle" slot="start"></ion-icon>
      Guide
    </ion-button>
  </div>

  <!-- Interactive Tutorial Overlay -->
  <div *ngIf="showInteractiveGuide" class="interactive-guide-overlay" (click)="closeInteractiveGuide()">
    <div class="guide-content" (click)="$event.stopPropagation()">
      <div class="guide-header">
        <h2>Emergency Alerts Guide</h2>
        <ion-button fill="clear" (click)="closeInteractiveGuide()">
          <ion-icon name="close"></ion-icon>
        </ion-button>
      </div>
      <div class="guide-steps">
        <div class="guide-step" [class.active]="currentGuideStep === 1">
          <h3>1. Alert Types</h3>
          <p>Different colors indicate different emergency types: Natural (orange), Medical (red), Security (blue)</p>
        </div>
        <div class="guide-step" [class.active]="currentGuideStep === 2">
          <h3>2. Priority Levels</h3>
          <p>High priority (red), Medium (yellow), Low (green) indicate urgency level</p>
        </div>
        <div class="guide-step" [class.active]="currentGuideStep === 3">
          <h3>3. Interactive Map</h3>
          <p>Tap on the map to see all active emergencies in your area</p>
        </div>
      </div>
      <div class="guide-navigation">
        <ion-button fill="clear" (click)="prevGuideStep()" [disabled]="currentGuideStep === 1">
          Previous
        </ion-button>
        <div class="step-indicators">
          <span *ngFor="let step of [1,2,3]" 
                [class.active]="step === currentGuideStep"
                (click)="setGuideStep(step)"></span>
        </div>
        <ion-button fill="clear" (click)="nextGuideStep()" [disabled]="currentGuideStep === 3">
          Next
        </ion-button>
        <ion-button color="primary" (click)="closeInteractiveGuide()" *ngIf="currentGuideStep === 3">
          Got It!
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Real-time Alert Banner -->
  <div *ngIf="criticalAlert" class="critical-alert-banner" @fadeIn (click)="viewAlertDetails(criticalAlert)">
    <div class="banner-content">
      <div class="banner-alert-icon">
        <ion-icon [name]="getAlertIcon(criticalAlert.type)" class="pulse-icon"></ion-icon>
        <div class="priority-badge">CRITICAL</div>
      </div>
      <div class="banner-text">
        <h3>{{criticalAlert.type | uppercase}} EMERGENCY</h3>
        <p class="banner-location">
          <ion-icon name="location"></ion-icon>
          {{criticalAlert.location}}
        </p>
        <p class="banner-time">
          <ion-icon name="time"></ion-icon>
          {{getTimeAgo(criticalAlert.time)}}
        </p>
      </div>
      <div class="banner-actions">
        <ion-button fill="clear" color="light" (click)="$event.stopPropagation(); navigateToLocation(criticalAlert)" class="action-btn">
          <ion-icon name="navigate"></ion-icon>
          Navigate
        </ion-button>
        <ion-button fill="clear" color="light" (click)="$event.stopPropagation(); shareAlert(criticalAlert)" class="action-btn">
          <ion-icon name="share"></ion-icon>
          Share
        </ion-button>
        <ion-button fill="clear" color="light" (click)="$event.stopPropagation(); dismissCriticalAlert()" class="action-btn">
          <ion-icon name="close"></ion-icon>
          Dismiss
        </ion-button>
      </div>
    </div>
    <div class="banner-progress" *ngIf="criticalAlert.expiresAt">
      <div class="progress-bar">
        <div class="progress-fill" [style.width]="getProgressWidth(criticalAlert) + '%'"></div>
      </div>
      <span class="progress-text">Expires in {{getTimeRemaining(criticalAlert)}}</span>
    </div>
  </div>

  <!-- Live Stats Overview -->
  <div class="stats-overview" @fadeIn>
    <div class="stats-header">
      <h3>Alert Overview</h3>
      <ion-button fill="clear" size="small" (click)="showStatsInfo()">
        <ion-icon name="information-circle"></ion-icon>
      </ion-button>
    </div>
    <div class="stats-grid">
      <div class="stat-card" [class.active]="totalAlerts > 0" (click)="filterByStatus('active')">
        <div class="stat-icon">
          <ion-icon name="alert-circle" color="danger"></ion-icon>
        </div>
        <div class="stat-content">
          <h3>{{totalAlerts}}</h3>
          <p>Total Alerts</p>
          <small>{{activeAlertsCount}} active</small>
        </div>
        <div class="stat-trend" [class.positive]="alertTrend > 0" [class.negative]="alertTrend < 0">
          <ion-icon [name]="alertTrend > 0 ? 'arrow-up' : 'arrow-down'"></ion-icon>
          <span>{{ getAbs(alertTrend) }}%</span>
        </div>
      </div>

      <div class="stat-card" [class.responding]="responseRate > 0" (click)="filterByStatus('responded')">
        <div class="stat-icon">
          <ion-icon name="people" color="success"></ion-icon>
        </div>
        <div class="stat-content">
          <h3>{{responseRate}}%</h3>
          <p>Response Rate</p>
          <small>{{respondedAlertsCount}} responded</small>
        </div>
        <div class="stat-trend" [class.positive]="responseTrend > 0" [class.negative]="responseTrend < 0">
          <ion-icon [name]="responseTrend > 0 ? 'arrow-up' : 'arrow-down'"></ion-icon>
          <span>{{ getAbs(responseTrend) }}%</span>
        </div>
      </div>

      <div class="stat-card" (click)="openMapView()">
        <div class="stat-icon">
          <ion-icon name="map" color="primary"></ion-icon>
        </div>
        <div class="stat-content">
          <h3>{{activeAlertsCount}}</h3>
          <p>Active Now</p>
          <small>Tap to view map</small>
        </div>
        <div class="stat-trend positive">
          <ion-icon name="pulse"></ion-icon>
          <span>Live</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Interactive Map Preview -->
  <div class="map-preview" (click)="openMapView()" @slideInUp>
    <div class="map-header">
      <div class="map-title">
        <h3>Live Alert Map</h3>
        <ion-badge color="danger" class="map-badge">{{activeAlertsCount}} active</ion-badge>
      </div>
      <ion-button fill="clear" size="small" (click)="$event.stopPropagation(); refreshMap()">
        <ion-icon name="refresh"></ion-icon>
      </ion-button>
    </div>
    <div class="map-container">
      <div class="map-overlay">
        <div class="alert-markers">
          <div *ngFor="let alert of emergencyAlerts.slice(0, 8)" 
               class="alert-marker" 
               [style.left]="alert.mapX + '%'" 
               [style.top]="alert.mapY + '%'"
               [class]="'marker-' + alert.priority"
               (click)="$event.stopPropagation(); viewAlertDetails(alert)">
            <ion-icon [name]="getAlertIcon(alert.type)"></ion-icon>
            <div class="marker-pulse"></div>
          </div>
        </div>
        <div class="map-placeholder">
          <ion-icon name="map" class="map-placeholder-icon"></ion-icon>
          <p>Tap to view real-time emergency map</p>
          <small>Showing {{emergencyAlerts.length}} alerts in your area</small>
        </div>
      </div>
    </div>
    <div class="map-legend">
      <div class="legend-item">
        <div class="legend-color high"></div>
        <span>High Priority</span>
      </div>
      <div class="legend-item">
        <div class="legend-color medium"></div>
        <span>Medium</span>
      </div>
      <div class="legend-item">
        <div class="legend-color low"></div>
        <span>Low</span>
      </div>
    </div>
  </div>

  <!-- Alert Type Summary -->
  <div class="alert-type-summary" @slideInUp>
    <div class="section-header">
      <h3 class="section-title">Alert Breakdown</h3>
      <ion-button fill="clear" size="small" (click)="exportStats()">
        <ion-icon name="download" slot="start"></ion-icon>
        Export
      </ion-button>
    </div>
    <div class="type-grid">
      <div class="type-item natural" (click)="filterByType('natural')">
        <div class="type-icon">
          <ion-icon name="flash"></ion-icon>
        </div>
        <div class="type-info">
          <h4>{{getAlertCount('natural')}}</h4>
          <p>Natural</p>
          <small>Earthquakes, Floods, etc.</small>
        </div>
        <div class="type-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width]="(getAlertCount('natural') / totalAlerts * 100) + '%'"></div>
          </div>
          <span class="progress-percent">{{(getAlertCount('natural') / totalAlerts * 100) | number:'1.0-0'}}%</span>
        </div>
      </div>

      <div class="type-item medical" (click)="filterByType('medical')">
        <div class="type-icon">
          <ion-icon name="medkit"></ion-icon>
        </div>
        <div class="type-info">
          <h4>{{getAlertCount('medical')}}</h4>
          <p>Medical</p>
          <small>Emergencies, Accidents</small>
        </div>
        <div class="type-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width]="(getAlertCount('medical') / totalAlerts * 100) + '%'"></div>
          </div>
          <span class="progress-percent">{{(getAlertCount('medical') / totalAlerts * 100) | number:'1.0-0'}}%</span>
        </div>
      </div>

      <div class="type-item security" (click)="filterByType('security')">
        <div class="type-icon">
          <ion-icon name="shield-checkmark"></ion-icon>
        </div>
        <div class="type-info">
          <h4>{{getAlertCount('security')}}</h4>
          <p>Security</p>
          <small>Incidents, Threats</small>
        </div>
        <div class="type-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width]="(getAlertCount('security') / totalAlerts * 100) + '%'"></div>
          </div>
          <span class="progress-percent">{{(getAlertCount('security') / totalAlerts * 100) | number:'1.0-0'}}%</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert Feed Header -->
  <div class="feed-header" @fadeIn>
    <div class="feed-title-section">
      <h2 class="feed-title">Recent Emergency Alerts</h2>
      <ion-chip (click)="toggleSortOrder()" class="sort-chip" [class.active]="sortOrder !== 'newest'">
        <ion-icon [name]="sortOrder === 'newest' ? 'time' : 'trending-up'"></ion-icon>
        <ion-label>{{sortOrder === 'newest' ? 'Latest' : 'Priority'}}</ion-label>
      </ion-chip>
    </div>
    <div class="feed-actions">
      <ion-button fill="clear" size="small" (click)="toggleViewMode()" class="view-toggle">
        <ion-icon [name]="isListView ? 'grid' : 'list'"></ion-icon>
      </ion-button>
      <ion-button fill="clear" size="small" (click)="exportAlerts()">
        <ion-icon name="download"></ion-icon>
      </ion-button>
    </div>
  </div>

  <!-- Emergency Alerts List -->
  <ion-list lines="none" class="alert-list" [class.grid-view]="!isListView">
    <ion-item 
      *ngFor="let alert of filteredAlerts; trackBy: trackByAlertId" 
      class="alert-card" 
      [class.unread]="!alert.read"
      [class.critical]="alert.priority === 'high'"
      [class.warning]="alert.priority === 'medium'"
      [class.normal]="alert.priority === 'low'"
      (click)="viewAlertDetails(alert)"
      (swipe)="onSwipe($event, alert)"
      @staggerSlideIn>
      
      <div class="alert-indicator" [class]="'indicator-' + alert.priority"></div>
      
      <ion-avatar class="alert-avatar">
        <div class="avatar-icon" [class]="'avatar-' + alert.type">
          <ion-icon [name]="getAlertIcon(alert.type)"></ion-icon>
        </div>
        <div class="live-badge" *ngIf="alert.status === 'Active'">
          <ion-spinner name="circular" color="danger"></ion-spinner>
        </div>
        <div class="expiry-badge" *ngIf="alert.expiresAt">
          {{getTimeRemaining(alert)}}
        </div>
      </ion-avatar>
      
      <ion-label class="alert-details">
        <div class="alert-header">
          <h2 class="alert-type">{{alert.type}} Alert</h2>
          <ion-badge [color]="getPriorityColor(alert.priority)" class="priority-badge">
            {{alert.priority}}
          </ion-badge>
        </div>
        <p class="alert-description">{{alert.description || 'Emergency situation reported'}}</p>
        <div class="alert-meta">
          <div class="meta-item">
            <ion-icon name="location"></ion-icon>
            <span>{{alert.location}}</span>
          </div>
          <div class="meta-item">
            <ion-icon name="time"></ion-icon>
            <span>{{getTimeAgo(alert.time)}}</span>
          </div>
          <div class="meta-item" *ngIf="alert.affectedPeople > 0">
            <ion-icon name="people"></ion-icon>
            <span>{{alert.affectedPeople}} affected</span>
          </div>
        </div>
        <div class="alert-tags" *ngIf="alert.tags && alert.tags.length > 0">
          <ion-chip *ngFor="let tag of alert.tags.slice(0, 2)" color="medium" outline>
            <ion-label>{{tag}}</ion-label>
          </ion-chip>
          <ion-chip *ngIf="alert.tags.length > 2" color="medium" outline>
            <ion-label>+{{alert.tags.length - 2}} more</ion-label>
          </ion-chip>
        </div>
      </ion-label>
      
      <div class="alert-actions">
        <div class="action-buttons">
          <ion-button fill="clear" size="small" (click)="$event.stopPropagation(); navigateToLocation(alert)">
            <ion-icon name="navigate" color="primary"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="$event.stopPropagation(); shareAlert(alert)">
            <ion-icon name="share" color="medium"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="$event.stopPropagation(); bookmarkAlert(alert)">
            <ion-icon [name]="alert.bookmarked ? 'bookmark' : 'bookmark-outline'" 
                     [color]="alert.bookmarked ? 'warning' : 'medium'"></ion-icon>
          </ion-button>
        </div>
        <div class="alert-status">
          <span class="status-text" [class]="'status-' + alert.status.toLowerCase()">
            {{alert.status}}
          </span>
        </div>
      </div>
    </ion-item>
  </ion-list>

  <!-- Load More Button -->
  <div class="load-more" *ngIf="hasMoreAlerts && !isLoading">
    <ion-button expand="block" fill="outline" (click)="loadMoreAlerts()" class="load-more-btn">
      <ion-icon name="add-circle" slot="start"></ion-icon>
      Load More Alerts
    </ion-button>
  </div>

  <!-- Empty State -->
  <div *ngIf="filteredAlerts.length === 0 && !isLoading" class="empty-state" @fadeIn>
    <div class="empty-icon">
      <ion-icon name="checkmark-done-circle"></ion-icon>
    </div>
    <h3>No alerts found</h3>
    <p *ngIf="alertFilter !== 'all' || searchQuery">Try changing your filters or search terms</p>
    <p *ngIf="alertFilter === 'all' && !searchQuery">All emergency situations are currently monitored</p>
    <div class="empty-actions">
      <ion-button fill="outline" (click)="clearFilters()">Clear Filters</ion-button>
      <ion-button fill="outline" (click)="refreshAlerts()">Check Again</ion-button>
    </div>
  </div>

  <!-- Emergency Action Button -->
  <div class="floating-action" @bounceIn [class.hidden]="isScrolled">
    <ion-fab vertical="bottom" horizontal="end" slot="fixed">
      <ion-fab-button color="danger" (click)="reportEmergency()" class="emergency-fab">
        <ion-icon name="alert"></ion-icon>
      </ion-fab-button>
    </ion-fab>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="loading-overlay">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Loading live alerts...</p>
    <small>Tracking {{emergencyAlerts.length}} active emergencies</small>
  </div>

  <!-- Connection Status -->
  <div *ngIf="!isConnected" class="connection-status">
    <ion-icon name="cloud-offline"></ion-icon>
    <span>Offline - Showing cached data</span>
    <ion-button fill="clear" size="small" (click)="checkConnection()">
      Retry
    </ion-button>
  </div>
</ion-content>